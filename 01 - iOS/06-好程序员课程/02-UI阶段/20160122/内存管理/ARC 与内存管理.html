<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.2 (452688)"/><meta name="keywords" content="内存管理, arc"/><meta name="author" content="junkcheung"/><meta name="created" content="2014-04-12 05:53:48 +0000"/><meta name="updated" content="2014-04-17 15:13:17 +0000"/><title>ARC 与内存管理</title></head><body style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
<h1 style="font-size: 1.5em; font-weight: normal; line-height: 1.25em; color: rgb(75, 75, 75); -webkit-hyphens: manual; max-width: 100%; font-family: Georgia, Palatino, Times, 'Times New Roman', serif; background-color: rgb(251, 251, 251);">ARC 与内存管理</h1>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">ARC: Automatic Reference Counting (自动引用计数)</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px;"><span style="background-color: rgb(251, 251, 251);">ARC 是</span> <span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);">iOS 5</span> <span style="background-color: rgb(251, 251, 251);">后推出的一项为Objective - C程序在</span><span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);">编译时</span><span style="background-color: rgb(251, 251, 251);">提供自动内存管理的功能。ARC可以让你把注意力集中在你感兴趣的代码，减少开发中的内存管理步骤，简化开发。</span></p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px;"><span style="background-color: rgb(251, 251, 251);">它通过指定的语法，让编译器(LLVM 3.0)在编译代码时，自动生成实例的引用计数管理部分代码。有一点，ARC并不是GC，它只是</span><span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);">一种代码静态分析（Static Analyzer）工具</span><span style="background-color: rgb(251, 251, 251);">。</span></p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在过往我们通常使用的是MRC: Manual Reference Counting(手动内存管理)。这些规则将逐渐变为本能，你会发现少一个release的代码怎么看怎么别扭，从而减少或者杜绝内存管理的错误。可以说MRC的规则非常简单，但是同时也非常容易出错。往往很小的错误就将引起crash或者leak之类问题。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">很多人担心内存管理不受自己控制，其实这是对于ARC机制了解不足从而不自信，所导致的对新事物的恐惧。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">下面我们从几个方面来详细介绍ARC到底如何实现，如何使用，它的好处，注意事项等。</p>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">需要的基本环境:</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px;"><span style="background-color: rgb(251, 251, 251);">ARC is supported in</span> <span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);">Xcode 4.2</span> <span style="background-color: rgb(251, 251, 251);">for OS X v10.6 and v10.7 (64-bit applications) and for iOS 4 and iOS 5. Weak references are not supported in OS X v10.6 and iOS 4.</span></p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px;"><strong style="-evernote-highlight:true;max-width: 100%; background-color: rgb(255, 250, 165);">注意：iOS4 不支持 weak 引用</strong></p>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">原理</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);"><img src="ARC%20%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.resources/69A041F5-0A79-410E-83C4-B6CBAB344CBB.jpg" height="476" width="751"/></p>
<pre style="max-width: 100%; white-space: pre-wrap; color: rgb(65, 65, 65); font-size: 17px; line-height: 27px;">
<code style="max-width: 100%;"><span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);">ARC的一个基本原则: 只要某个对象被任一strong指针引用，那么它将不会被销毁。当对象没有被任何strong指针引用时，那么就将被销毁。</span><span style="background-color: rgb(251, 251, 251);"
/></code>
</pre>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">默认行为</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">对象默认声明为 strong 类型, ARC 确保对象在函数体内是不会被 dealloc。比如</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">void</span><span style="max-width: 100%;">)</span><span style="max-width: 100%; font-weight: bold;">takeLastNameFrom:</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">Person</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">person</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">NSString</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">oldLastname</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[</span><span style="max-width: 100%;">self</span> <span style="max-width: 100%;">lastName</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">[</span><span style="max-width: 100%;">self</span> <span style="max-width: 100%;">setLastName:</span><span style="max-width: 100%;">[</span><span style="max-width: 100%;">person</span> <span style="max-width: 100%;">lastName</span><span style="max-width: 100%;">]];</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">NSLog</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">@"Lastname changed from %@ to %@"</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">oldLastname</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">[</span><span style="max-width: 100%;">self</span> <span style="max-width: 100%;">lastName</span><span style="max-width: 100%;">]);</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">强制规则</h2>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">
<p style="max-width: 100%;">你不能再调用 dealloc 或者实现、调用 retain, release, retainCount, autorelease, 同样@selector(retain), @selector(release)也是不允许的， 当然你可以实现 dealloc 方法，来管理你的实例变量，或者你会调用 [systemClassInstance setDelegate:nil]等.定制的 dealloc 方法不需要写 [super dealloc],这个动作会默认调用。</p>
<p style="max-width: 100%;">你仍然可以用 CFRetain, CFRelease 和相关Core Foundation方法。 如果要管理这类对象可以参考：(Managing Toll-Free Bridging 管理自由桥接)</p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">你不能使用 NSAllocateObject 或 NSDeallocateObject</p>
<p style="max-width: 100%;">创建对象用 alloc</p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">你不能在 C 结构体中使用对象指针</p>
<p style="max-width: 100%;">因此下面代码是不可用的</p>
</li>
</ul>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">typedef</span> <span style="max-width: 100%;">struct</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">UIImage</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">selectedImage</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">UIImage</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">disabledImage</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span> <span style="max-width: 100%;">ButtonImages</span><span style="max-width: 100%;">;</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">建议是用 OC类来管理它们</p>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">
<p style="max-width: 100%;">不能随意在 id 与 void * 之间随意转换</p>
<p style="max-width: 100%;">编译器同样是无法管理 void * 这类 Core Foundation类型的东东，都要用 Managing Toll-Free Bridging 进行生命同期的管理。</p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">你不能再使用 NSAutoreleasePool 对象</p>
<p style="max-width: 100%;">ARC 提供了性能更好的 @autoreleasepool block 替换原来这类使用方式。</p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">你不能使用内存区</p>
<p style="max-width: 100%;">你不需要再使用 NSZone 等这类对象，因为现在Objective-C运行时已经忽略NSZone了，所以没必要再使用NSZone了。</p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">你不能使用 new 开头的属性名，但你可以手动指定 getter 方法名</p>
<p style="max-width: 100%;">例如:</p>
</li>
</ul>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="-evernote-highlight:true;max-width: 100%; background-color: rgb(255, 250, 165);"><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// 非法:</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@property</span> <span style="max-width: 100%;">NSString</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">newTitle</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"
/><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// OK:</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@property</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">getter</span><span style="max-width: 100%; font-weight: bold;">=</span><span style="max-width: 100%;">theNewTitle</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">NSString</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">newTitle</span><span style="max-width: 100%;">;</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<h1 style="font-size: 1.25em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">ARC 新的对象生命周期声明</h1>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">属性</li>
</ul>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// 用 strong 代替 retain, @property(retain) MyClass *myObject;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@property</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">strong</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">MyClass</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">myObject</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"
/><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// 用 weak 代替 assign "@property(assign) MyClass *myObject;"</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// 实例变量被释放后，会自动赋予 nil 指针，省得我们自己在手动赋nil操作。</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@property</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">weak</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">MyClass</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">myObject</span><span style="max-width: 100%;">;</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在 ARC 中 strong 将是默认的类型.</p>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">变量</li>
</ul>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">变量同样有以下几种管理生命周期的声明</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">__strong</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">__weak</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">__unsafe_unretained</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">__autoreleasing</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">__unsafe_unretained 类似原来的 assign</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">所以你可以这样声明这些对象</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">MyClass</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__weak</span> <span style="max-width: 100%;">myWeakReference</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">MyClass</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__unsafe_unretained</span> <span style="max-width: 100%;">myUnsafeReference</span><span style="max-width: 100%;">;</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px;"><span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);">需要注意的是 __weak 变量在栈中的情况，例如:</span></p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);"><span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>

</span>
</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="-evernote-highlight:true;max-width: 100%; background-color: rgb(255, 250, 165);"><span style="max-width: 100%;">NSString</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__weak</span> <span style="max-width: 100%;">string</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[[</span><span style="max-width: 100%;">NSString</span> <span style="max-width: 100%;">alloc</span><span style="max-width: 100%;">]</span> <span style="max-width: 100%;">initWithFormat:</span><span style="max-width: 100%;">@"First Name: %@"</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">[</span><span style="max-width: 100%;">self</span> <span style="max-width: 100%;">firstName</span><span style="max-width: 100%;">]];</span>
</span><span style="max-width: 100%;"><span style="-evernote-highlight:true;background-color: rgb(255, 250, 165);"><span style="max-width: 100%;">NSLog</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">@"string: %@"</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">string</span><span style="max-width: 100%;">);</span></span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">尽管 string 被实例化，但由于 string 声明为 weak 类型，它没有 strong 这个引用，所以他在赋值后立即就被释放了,在Log它时，它已经被释放了。</p>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">同样你也要注意对象值传递. 比如下面的代码</h2>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">NSError</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">error</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">BOOL</span> <span style="max-width: 100%;">OK</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[</span><span style="max-width: 100%;">myObject</span> <span style="max-width: 100%;">performOperationWithError:</span><span style="max-width: 100%; font-weight: bold;">&amp;</span><span style="max-width: 100%;">error</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">if</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%; font-weight: bold;">!</span><span style="max-width: 100%;">OK</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%; font-style: italic;">// Report the error.</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%; font-style: italic;">// ...</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">实际上这个代码是这样隐示声明的</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">而函数是这样被声明了的</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;">-</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">BOOL</span><span style="max-width: 100%;">)</span><span style="max-width: 100%; font-weight: bold;">performOperationWithError:</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">NSError</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__autoreleasing</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">error</span><span style="max-width: 100%;">;</span>
</code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">所以最后编译的结果就是:</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>
<span style="max-width: 100%;">7</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">NSError</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__strong</span> <span style="max-width: 100%;">error</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">NSError</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__autoreleasing</span> <span style="max-width: 100%;">tmp</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">error</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">BOOL</span> <span style="max-width: 100%;">OK</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[</span><span style="max-width: 100%;">myObject</span> <span style="max-width: 100%;">performOperationWithError:</span><span style="max-width: 100%; font-weight: bold;">&amp;</span><span style="max-width: 100%;">tmp</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">error</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">tmp</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">if</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%; font-weight: bold;">!</span><span style="max-width: 100%;">OK</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%; font-style: italic;">// Report the error.</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%; font-style: italic;">// ...</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">当本地变量声明(<strong style="max-width: 100%;">strong *error)和函数的参数((NSError * </strong>autoreleasing <em style="max-width: 100%;">)error)不匹配的时候，编译器会创建一个临时变量。当你获得一个<strong style="max-width: 100%;">strong变量的地址时，你可以初始化一个id </strong>strong </em>的指针来声明 ，这样你就可以获得指针的原型，或者你可以声明一个变量为 __autoreleasing。</p>
<h1 style="font-size: 1.25em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">避免循环引用</h1>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">你可以使用生命周期修饰符来避免Strong引用周期。例如，当你制作了一组父子结构的对象，而且父类要引用子类，则会出现Strong引用周期；反之，当 你将一个父类指向子类为strong引用，子类指向父类为weak引用，就可以避免出现Strong引用周期。当对象包含block objects时，这样的情况会变的更加隐性。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在手动内存管理模式下， <code style="max-width: 100%;">__block id x</code>; x不会被 retaining 在ARC模式下，<code style="max-width: 100%;">__block id x</code> , 默认被retaining</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">为了使手动内存管理模式代码可以在ARC模式下正常工作， 你可以用<code style="max-width: 100%;">__unsafe_unretained</code> 来修饰 <code style="max-width: 100%;">__block id</code> x;。就和”<strong style="max-width: 100%;">unsafe_unretained”字面上的意思一样, 不过,这样一个non-retained变量是危险的(因为它会变成一个野指 针) 会带来不良后果。有两种更好一点的方法来处理，一是使用</strong>weak (当你不需要支持iOS 4或OS X v10.6), 二是设__block值为nil，结束他的生命周期。</p>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">这是MRC时代处理 __block 里对象释放问题:</li>
</ul>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>
<span style="max-width: 100%;">7</span>
<span style="max-width: 100%;">8</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[[</span><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%;">alloc</span><span style="max-width: 100%;">]</span> <span style="max-width: 100%;">init</span><span style="max-width: 100%;">…</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">myController</span><span style="max-width: 100%;">.</span><span style="max-width: 100%;">completionHandler</span> <span style="max-width: 100%; font-weight: bold;">=</span>  <span style="max-width: 100%; font-weight: bold;">^</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">NSInteger</span> <span style="max-width: 100%;">result</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">   <span style="max-width: 100%;">[</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%;">dismissViewControllerAnimated:</span><span style="max-width: 100%;">YES</span> <span style="max-width: 100%;">completion:</span><span style="max-width: 100%;">nil</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">};</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">[</span><span style="max-width: 100%;">self</span> <span style="max-width: 100%;">presentViewController:</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%;">animated:</span><span style="max-width: 100%;">YES</span> <span style="max-width: 100%;">completion:</span><span style="max-width: 100%; font-weight: bold;">^</span><span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">   <span style="max-width: 100%;">[</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%;">release</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}];</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">你可以使用 __block修饰符然后设置myController的值为nil 替代上面的方式:</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__block</span> <span style="max-width: 100%;">myController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[[</span><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%;">alloc</span><span style="max-width: 100%;">]</span> <span style="max-width: 100%;">init</span><span style="max-width: 100%;">…</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">myController</span><span style="max-width: 100%;">.</span><span style="max-width: 100%;">completionHandler</span> <span style="max-width: 100%; font-weight: bold;">=</span>  <span style="max-width: 100%; font-weight: bold;">^</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">NSInteger</span> <span style="max-width: 100%;">result</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">[</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%;">dismissViewControllerAnimated:</span><span style="max-width: 100%;">YES</span> <span style="max-width: 100%;">completion:</span><span style="max-width: 100%;">nil</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">myController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">nil</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">};</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">无伦哪种形式，你都可以使用一个 weak 引用对象避免循环引用:</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[[</span><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%;">alloc</span><span style="max-width: 100%;">]</span> <span style="max-width: 100%;">init</span><span style="max-width: 100%;">…</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__weak</span> <span style="max-width: 100%;">weakMyViewController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">myController</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">myController</span><span style="max-width: 100%;">.</span><span style="max-width: 100%;">completionHandler</span> <span style="max-width: 100%; font-weight: bold;">=</span>  <span style="max-width: 100%; font-weight: bold;">^</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">NSInteger</span> <span style="max-width: 100%;">result</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">[</span><span style="max-width: 100%;">weakMyViewController</span> <span style="max-width: 100%;">dismissViewControllerAnimated:</span><span style="max-width: 100%;">YES</span> <span style="max-width: 100%;">completion:</span><span style="max-width: 100%;">nil</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">};</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在某个时候这个对象，如果放在异步执行时，对象可能已经被释放，所以需要一个 strong 的对象把它 hold 住。</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>
<span style="max-width: 100%;">7</span>
<span style="max-width: 100%;">8</span>
<span style="max-width: 100%;">9</span>
<span style="max-width: 100%;">10</span>
<span style="max-width: 100%;">11</span>
<span style="max-width: 100%;">12</span>
<span style="max-width: 100%;">13</span>
<span style="max-width: 100%;">14</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">myController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[[</span><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%;">alloc</span><span style="max-width: 100%;">]</span> <span style="max-width: 100%;">init</span><span style="max-width: 100%;">…</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span> <span style="max-width: 100%;">__weak</span> <span style="max-width: 100%;">weakMyController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">myController</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">myController</span><span style="max-width: 100%;">.</span><span style="max-width: 100%;">completionHandler</span> <span style="max-width: 100%; font-weight: bold;">=</span>  <span style="max-width: 100%; font-weight: bold;">^</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">NSInteger</span> <span style="max-width: 100%;">result</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">MyViewController</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">strongMyController</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">weakMyController</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">if</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">strongMyController</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">        <span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;">        <span style="max-width: 100%;">[</span><span style="max-width: 100%;">strongMyController</span> <span style="max-width: 100%;">dismissViewControllerAnimated:</span><span style="max-width: 100%;">YES</span> <span style="max-width: 100%;">completion:</span><span style="max-width: 100%;">nil</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;">        <span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">else</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">        <span style="max-width: 100%; font-style: italic;">// Probably nothing...</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">};</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">栈里的变量初始化即为 nil</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">使用ARC后， strong, weak, autoreleasing 栈里的变量默认初始为nil</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">void</span><span style="max-width: 100%;">)</span><span style="max-width: 100%; font-weight: bold;">myMethod</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">NSString</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">name</span><span style="max-width: 100%;">;</span> <span style="max-width: 100%; font-style: italic;">// 这里 name 已经被赋予了nil指针， 所以下面的代码不会出错。</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">NSLog</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">@"name: %@"</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">name</span><span style="max-width: 100%;">);</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">修改编译的Flag 打开和关闭 ARC</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">如果有遇到第三方插件，或有一些文件你不想用 ARC 来控制，可以在 Build Phases &gt; Compile Sources &gt; 某个文件上 &gt; Compiler Flags: -fno-objc-arc</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">相互如果想在部分文件中用到 arc 则标记上: -fobjc-arc</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);"/>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">Managing Toll-Free Bridging</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">由于ARC不能管理Core Foundation Object的生命周期，所以在Core Foundation和ARC之间，我们需要使用到<strong style="max-width: 100%;">bridge,</strong>bridge_retained和__bridge_transfer三个转换关键字。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">__bridge只做类型转换，但是不修改对象（内存）管理权；</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">__bridge_retained（也可以使用CFBridgingRetain）将Objective-C的对象转换为Core Foundation的对象，同时将对象（内存）的管理权交给我们，后续需要使用CFRelease或者相关方法来释放对象；</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">__bridge_transfer（也可以使用CFBridgingRelease）将Core Foundation的对象转换为Objective-C的对象，同时将对象（内存）的管理权交给ARC。</p>
<h2 style="font-size: 1.125em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">使用weak property声明Outlet</h2>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在被ARC处理过的iOS和OS X中，声明的outlets将会趋于统一。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">一般来说outlets变量被修饰为weak，但是如果outlets变量的所有者是nib文件中的top-level对象(或者是storyboard scene)时，应被修饰为strong。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">详细参考Resource Programming Guide中的“Nib Files”。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">当我们使用 Interface Builder 生成Outlet对象的时候，一般都是作为 subview 来使用的。比如 UIViewController 的view。所以说Outlet的持有者就是superview对象，即有“父子”关系。我们知道，当对象间有“父子”关系时，需要使用弱参照，以避免“循环参照”。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">ViewController 本身是不会作为Outlet的所有者的，所以使用weak property声明。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);"/>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">简化viewDidUnload</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">Outlet都使用weak property声明的时候，还有一个好处，就是简化viewDidUnload的处理。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">iOS在系统内存不足的时候，UIViewController会将没有表示的所有view做unload处理，即调用viewDidUnload接口。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">所以，如果是强参照的情况下，需要释放所有权，</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">@property</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">nonatomic</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">strong</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">IBOutlet</span> <span style="max-width: 100%;">UILabel</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">label</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"
/><span style="max-width: 100%;"><span style="max-width: 100%;">-</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">void</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%; font-weight: bold;">viewDidUnload</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">self</span><span style="max-width: 100%;">.</span><span style="max-width: 100%;">label</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">nil</span><span style="max-width: 100%;">;</span> <span style="max-width: 100%; font-style: italic;">// 取消强参照，释放所有权</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">[</span><span style="max-width: 100%;">super</span> <span style="max-width: 100%;">viewDidUnload</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">如果没有 self.label = nil 的处理，那么 UIViewController 将不会释放 label 的所有权；结果，系统是调用了unload，但是subview对象始终留在内存中。随着界面上控件的增多，内存泄露会越来越大。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">如果使用的是weak property声明的话，会是怎样的呢？</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;">@property</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">nonatomic</span><span style="max-width: 100%;">,</span> <span style="max-width: 100%;">weak</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">IBOutlet</span> <span style="max-width: 100%;">UILabel</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">label</span><span style="max-width: 100%;">;</span>
</code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">这时，系统在unload时，由于label没有被强参照，更加ARC的规则，这时，label的对象即被释放。并在释放的同时，变量自动指向nil。</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">void</span><span style="max-width: 100%;">)</span><span style="max-width: 100%; font-weight: bold;">viewDidUnload</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%; font-style: italic;">// 这里什么也不用管</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">[</span><span style="max-width: 100%;">super</span> <span style="max-width: 100%;">viewDidUnload</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">其实，如果我们的viewDidUnload只是用来释放Outlet用的话，那么该函数也可以不被重载的。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">什么时候要用strong property</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">由上我们也可以看到，并不是所有的Outlet都用weak来声明都是正确的；当使用Interface Builder生成的第一层的view或者windows被作为Outlet来使用的话，那么不是不能声明为weak property的。（比如，Storyboard的各个scene）</p>
<h1 style="font-size: 1.25em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">转化原MRC项目到ARC</h1>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">
<p style="max-width: 100%;">用Xcode自带工具转换MRC项目到ARC: Edit &gt; Refactor &gt; Convert to Objective-C ARC)</p>
<p style="max-width: 100%;"/>
<p style="max-width: 100%;">在这个选项下，还有一个 Convert to Modern Objective-C Syntax.. 转化成更现代的写法, 有兴趣的可以试试。:)</p>
<p style="max-width: 100%;">在转化的过程中，编译器会先对代码进行检查，如果遇到错误警告，可以根据提示进行处理后，再进行转化 (如果你要无视这些错误可以在Preferences 里设定 Continue building after errors)</p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">将项目用ARC方式编译 Build Settings -&gt; LLVM compiler 将 Objective-C Automatic Reference Counting 设置为 Yes</p>
<p style="max-width: 100%;"/>
</li>
</ul>
<h1 style="font-size: 1.25em; max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; line-height: 27px; background-color: rgb(251, 251, 251);">常见问题</h1>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">
<p style="max-width: 100%;">通常遇到的错误有这样一些：</p>
<p style="max-width: 100%;"><code style="max-width: 100%;">Receiver type ‘X’ for instance message is a forward declaration</code></p>
<p style="max-width: 100%;">这往往是引用的问题。ARC要求完整的前向引用，也就是说在MRC时代可能只需要在.h中申明@class就可以，但是在ARC中如果调用某个子类中未覆盖的父类中的方法的话，必须对父类.h引用，否则无法编译。</p>
<p style="max-width: 100%;"><code style="max-width: 100%;">Switch case is in protected scope</code></p>
<p style="max-width: 100%;">现在switch语句必须加上{}了，ARC需要知道局部变量的作用域，加上{}后switch语法更加严格，否则遇到没有break的分支的话内存管理会出现问题。</p>
<p style="max-width: 100%;"><code style="max-width: 100%;">A name is referenced outside the NSAutoreleasePool scope that it was declared in</code></p>
<p style="max-width: 100%;">这是由于写了自己的 autoreleasepool，而在转换时在原来的pool中申明的变量在新的@autoreleasepool中作用域将被局限。解决方法是把变量申明拿到pool的申请之前。</p>
<p style="max-width: 100%;"><code style="max-width: 100%;">ARC forbids Objective-C objects in structs or unions</code></p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;">ARC 需要你指定 super init 的结果到 self [super init]; // 这将是无效的</p>
<p style="max-width: 100%;">推荐用</p>
</li>
</ul>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;">   <span style="max-width: 100%;">self</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">[</span><span style="max-width: 100%;">super</span> <span style="max-width: 100%;">init</span><span style="max-width: 100%;">];</span>
</span><span style="max-width: 100%;">   <span style="max-width: 100%;">if</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">self</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">  <span style="max-width: 100%;">...</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">实例变量会变成 strong 类型</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在用 ARC 之前, thing 这个变量是一个 weak 类型</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>
<span style="max-width: 100%;">7</span>
<span style="max-width: 100%;">8</span>
<span style="max-width: 100%;">9</span>
<span style="max-width: 100%;">10</span>
<span style="max-width: 100%;">11</span>
<span style="max-width: 100%;">12</span>
<span style="max-width: 100%;">13</span>
<span style="max-width: 100%;">14</span>
<span style="max-width: 100%;">15</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">@interface</span> <span style="max-width: 100%;">MyClass</span> : <span style="max-width: 100%;">Superclass</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">id</span> <span style="max-width: 100%;">thing</span><span style="max-width: 100%;">;</span> <span style="max-width: 100%; font-style: italic;">// Weak reference.</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@end</span>
</span><span style="max-width: 100%;"
/><span style="max-width: 100%;"><span style="max-width: 100%;">@</span><span style="max-width: 100%;">implementation</span> <span style="max-width: 100%;">MyClass</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-weight: bold;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">id</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">thing</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">return</span> <span style="max-width: 100%;">thing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-weight: bold;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">void</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">setThing:</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">id</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">newThing</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">thing</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">newThing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@end</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">使用 ARC 后，thing 变量实际上是默认用了 strong 类型，所以如果你要想继续使用 weak 类型，必须显示声明</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>
<span style="max-width: 100%;">7</span>
<span style="max-width: 100%;">8</span>
<span style="max-width: 100%;">9</span>
<span style="max-width: 100%;">10</span>
<span style="max-width: 100%;">11</span>
<span style="max-width: 100%;">12</span>
<span style="max-width: 100%;">13</span>
<span style="max-width: 100%;">14</span>
<span style="max-width: 100%;">15</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">@interface</span> <span style="max-width: 100%;">MyClass</span> : <span style="max-width: 100%;">Superclass</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">id</span> <span style="max-width: 100%;">__weak</span> <span style="max-width: 100%;">thing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@end</span>
</span><span style="max-width: 100%;"
/><span style="max-width: 100%;"><span style="max-width: 100%;">@</span><span style="max-width: 100%;">implementation</span> <span style="max-width: 100%;">MyClass</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-weight: bold;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">id</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">thing</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">return</span> <span style="max-width: 100%;">thing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-weight: bold;">-</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">void</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">setThing:</span><span style="max-width: 100%;">(</span><span style="max-width: 100%;">id</span><span style="max-width: 100%;">)</span><span style="max-width: 100%;">newThing</span> <span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">thing</span> <span style="max-width: 100%; font-weight: bold;">=</span> <span style="max-width: 100%;">newThing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@end</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">或</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>
<span style="max-width: 100%;">5</span>
<span style="max-width: 100%;">6</span>
<span style="max-width: 100%;">7</span>
<span style="max-width: 100%;">8</span>
<span style="max-width: 100%;">9</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">@interface</span> <span style="max-width: 100%;">MyClass</span> : <span style="max-width: 100%;">Superclass</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@property</span> <span style="max-width: 100%;">(</span><span style="max-width: 100%;">weak</span><span style="max-width: 100%;">)</span> <span style="max-width: 100%;">id</span> <span style="max-width: 100%;">thing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@end</span>
</span><span style="max-width: 100%;"
/><span style="max-width: 100%;"><span style="max-width: 100%;">@implementation</span> <span style="max-width: 100%;">MyClass</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@synthesize</span> <span style="max-width: 100%;">thing</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%; font-style: italic;">// ...</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">@end</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">首先，我们需要转变一下观念, 对于在.h中申明的实例变量：</li>
</ul>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">@interface</span> <span style="max-width: 100%;">MainViewController</span> : <span style="max-width: 100%;">UIViewController</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">  <span style="max-width: 100%;">NSOperationQueue</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">queue</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">我们不妨仔细考虑一下，为什么在interface里出现了实例变量的申明？通常来说，实例变量只是在类的实例中被使用，而你所写的类的使用者并没有太多必要了解你的类中有哪些实例变量。而对于绝大部分的实例变量，应该都是protected或者private的，对它们的操作只应该用setter和getter，而这正是property所要做的工作。可以说，将实例变量写在头文件中是一种遗留的陋习。更好的写实例变量名字的地方应当与类实现关系更为密切，为了隐藏细节，我们应该考虑将它们写在@implementation里。好消息是，在LLVM3.0中，不论是否开启ARC，编译器是支持将实例变量写到实现文件中的。甚至如果没有特殊需要又用了property，我们都不应该写无意义的实例变量申明，因为在@synthesize中进行绑定时，我们就可以设置变量名字了，这样写的话可以让代码更加简洁。</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">在这里我们对实例变量申明移到.m里中。修改后的.h是这样的，十分简洁</p>
<div style="max-width: 100%;">
<table style="font-size: 0.9em; word-wrap: break-word; max-width: 100%;">
<tbody style="max-width: 100%;">
<tr style="max-width: 100%;">
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<span style="max-width: 100%;">1</span>
<span style="max-width: 100%;">2</span>
<span style="max-width: 100%;">3</span>
<span style="max-width: 100%;">4</span>

</pre></td>
<td style="max-width: 100%;">
<pre style="max-width: 100%; white-space: pre-wrap;">
<code style="max-width: 100%;"><span style="max-width: 100%;"><span style="max-width: 100%;">@implementation</span> <span style="max-width: 100%;">MainViewController</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">{</span>
</span><span style="max-width: 100%;">    <span style="max-width: 100%;">NSOperationQueue</span> <span style="max-width: 100%; font-weight: bold;">*</span><span style="max-width: 100%;">queue</span><span style="max-width: 100%;">;</span>
</span><span style="max-width: 100%;"><span style="max-width: 100%;">}</span>
</span></code>
</pre></td>
</tr>
</tbody>
</table>
</div>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">这样的写法让代码相当灵活，而且不得不承认.m确实是这些实例变量的应该在的地方</p>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">参考资料:</p>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;"><a style="color: rgb(65, 110, 210); max-width: 100%;">About Memory Management</a></li>
</ul>
<p style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);"><img src="ARC%20%E4%B8%8E%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.resources/D19654DE-958B-40A8-9A2D-363878303413.png" height="822" width="1393"/></p>
<ul style="max-width: 100%; color: rgb(65, 65, 65); font-family: Georgia, Palatino, Times, 'Times New Roman', serif; font-size: 17px; line-height: 27px; background-color: rgb(251, 251, 251);">
<li style="max-width: 100%;">
<p style="max-width: 100%;"><a href="http://developer.apple.com/library/ios/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html" style="color: rgb(65, 110, 210); text-decoration: none; max-width: 100%;">Transitioning to ARC</a></p>
</li>
<li style="max-width: 100%;">
<p style="max-width: 100%;"><a href="http://clang.llvm.org/docs/AutomaticReferenceCounting.html#blocks" style="color: rgb(65, 110, 210); text-decoration: none; max-width: 100%;">Objective-C Automatic Reference Counting</a></p>
</li>
</ul>
</body></html>